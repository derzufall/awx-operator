# AWX Operator Custom Resource Definitions

This document describes the Custom Resource Definitions (CRDs) used by the AWX Operator.

## Overview

The AWX Operator uses the following Custom Resource Definitions:

1. `AwxConnection` - Defines an AWX instance connection that the operator will manage.
2. `AwxProject` - Defines an AWX project that the operator will create and maintain in an AWX instance.

## Status Model

All resources in the AWX Operator share a common status model based on Kubernetes best practices:

### Common Status Fields

All resource statuses include these fields:

* `message` - Informational message about the current status
* `phase` - Current phase of the resource (Pending, Running, Succeeded, Failed, Unknown)
* `firstSuccessfulSync` - Time when the resource was first successfully synchronized
* `lastUpdateTime` - Time of the last status update
* `observedGeneration` - The resource generation that this status reflects
* `conditions` - List of conditions representing the resource's state

### Status Conditions

Conditions provide detailed status information for resources. Each condition has:

* `type` - Type of the condition (e.g., Ready, Available, Progressing)
* `status` - Status of the condition (True, False, Unknown)
* `lastTransitionTime` - Last time the condition status changed
* `lastUpdateTime` - Last time the condition was updated
* `reason` - Machine-readable reason for the condition's status
* `message` - Human-readable message about the condition

## AwxConnection CRD

The `AwxConnection` CRD represents a connection to an AWX instance that the operator can manage.

### Specification

[source,yaml]
----
apiVersion: wolkenzentrale.de/v1alpha1
kind: AwxConnection
metadata:
  name: awx-example
  namespace: default
spec:
  url: "https://awx.example.com"
  username: "admin"
  passwordSecretName: "awx-creds"
  passwordSecretKey: "password"
  insecureSkipTlsVerify: false
----

The `spec` field contains the following properties:

* `url` - The URL of the AWX instance
* `username` - The username for authenticating with the AWX instance
* `passwordSecretName` - The name of the Kubernetes secret containing the password
* `passwordSecretKey` - The key in the secret that contains the password
* `insecureSkipTlsVerify` - Whether to skip TLS verification (default: false)

### Status

In addition to the common status fields, the AwxConnection status includes:

* `connectionStatus` - The current connection status (Connected, Disconnected, Error)
* `lastConnected` - Timestamp of last successful connection
* `awxVersion` - AWX version reported by the instance
* `failedConnectionAttempts` - Number of failed connection attempts

## AwxProject CRD

The `AwxProject` CRD represents a project in AWX.

### Specification

[source,yaml]
----
apiVersion: wolkenzentrale.de/v1alpha1
kind: AwxProject
metadata:
  name: example-project
  namespace: default
spec:
  awxConnectionRef:
    name: my-awx
    # namespace: default  # Optional: defaults to same namespace as this resource
  name: "Example Project"
  description: "An example project managed by the AWX Operator"
  scmType: "git"
  scmUrl: "https://github.com/example/example-project.git"
  scmBranch: "main"
----

The `spec` field contains the following properties:

* `awxConnectionRef` - Reference to the AwxConnection resource to use for this project
  * `name` - Name of the AwxConnection resource (required)
  * `namespace` - Namespace of the AwxConnection resource (optional, defaults to same namespace)
* `name` - The name of the AWX project
* `description` - Description of the AWX project
* `scmType` - The SCM type for the project (git, svn, etc.)
* `scmUrl` - The SCM URL for the project 
* `scmBranch` - The SCM branch for the project

### Status

In addition to the common status fields, the AwxProject status includes:

* `awxId` - The ID of the project in AWX 
* `created` - When the project was created in AWX
* `modified` - When the project was last modified in AWX
* `status` - The project status as reported by AWX
* `lastUpdateJobTime` - Last time a project update was initiated
* `lastUpdateJobId` - ID of the last update job in AWX 

## Project Models

The AWX Operator uses a layered approach to handle projects:

1. `Project` - Plain model for AWX API communication
2. `ProjectSpec` - Enhanced model for Kubernetes CRD with extra fields like `awxConnectionRef`

This separation allows us to:
1. Keep AWX API models clean and compatible with the AWX REST API
2. Add Kubernetes-specific fields needed for CRD functionality
3. Easily convert between the two with the `toProject()` method

### Model Inheritance

```
Project (AWX API model)
    ^
    |
    +-- ProjectSpec (Kubernetes CRD model with awxConnectionRef)
``` 